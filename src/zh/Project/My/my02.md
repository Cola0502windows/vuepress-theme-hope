---
title: Reggie
icon: github
---

# Reggie

> Author：Cola
>
> Time：2023.1.28 15：54 PM
>
> To：瑞吉外卖项目

> 项目介绍：
>
> - 前置知识
>   - Java 基础知、Java Web
>   - SpringBoot、SSM （Spring、Spring MVC、MyBatis）
>   - MySQL
>   - Maven
> - 收获：
>   - 对企业开发有基本的认识
>   - Git 
>   - Redis
>   -  TODO
>
> TODO 思维导图

## Features

> - [ ] 基础
> - [ ] Pro （主从数据库、Redis、Nginx 等）

### 一、基础

> - [x]  数据库设计
> - [x] 代码构建

#### 1.1 数据库设计

> 学习笔记：[MySQL 数据库设计三大规范](TODO) 
>
> 本项目主要涉及：
>
> - 实体表（用于维护实体类）
> - 关系表 （用于维护各表间的关系）

> 实体表

| 表名          | 说明                         |
| ------------- | ---------------------------- |
| employee      | 员工表，用于存放员工相关信息 |
| category      | 菜品和套餐分类表             |
| dish          | 菜品表                       |
| setmeal       | 套餐表                       |
| user          | C 端 用户表                  |
| address_book  | 地址簿表                     |
| shopping_cart | 购物车表                     |
| orders        | 订单表                       |
| order_detail  | 订单明细表                   |

> 关系表

| 表名         | 说明           |
| ------------ | -------------- |
| setmeal_dish | 套餐菜品关系表 |
| dish_flavor  | 菜品口味关系表 |

#### 1.2 代码构建

> - [x] 前端代码
> - [ ] 后端代码

##### 1.2.1 前端代码

> 本项目主要涉及的是后端工程，因此前端代码以提供形式给出。

##### 1.2.2 后端代码

> 本项目主要采用 SpringBoot 进行构建因此后端结构主要为：
>
> - 启动类 
> - common 工具类
> - controller 控制类
>   - 普通 controller
>   - config 配置类
>   - fitter 过滤器
> - domain 实体类
> - dto 数据类
> - mapper
> - service
>   - Impl

###### 启动类 `ManagerApplication`

```java
/**
 * @ Name: ManagerApplication
 * @ Author: Cola
 * @ Time: 2022/12/27 18:03
 * @ Description: ManagerApplication
 */
@SpringBootApplication
@ServletComponentScan
@EnableTransactionManagement
@Slf4j
public class ManagerApplication {
    public static void main(String[] args) {
        SpringApplication.run(ManagerApplication.class);
        log.info("项目启动成功");
    }
}

```



###### 1.2.2.1 common 工具类

> common 工具类
>
> - [x] BaseContext
> - [x] GlobalExceptionHandler
> - [x] JacksonObjectMapper
> - [x] MyMetaObjectHandler
> - [x] SMSUtils
> - [x] ValidateCodeUtils
> - [x] CustomException

> BaseContext

```java
/**
 * @ Name: BaseContext
 * @ Author: Cola
 * @ Time: 2022/12/27 20:11
 * @ Description: 基于 ThreadLocal 封装工具类，用户保存和获取当前登录用户 id
 */
public class BaseContext {
    private static ThreadLocal<Long> threadLocal = new ThreadLocal<>();

    /**
     * 设置值
     * @param id 当前登录用户的 id
     */
    public static void setCurrentId(Long id){
        threadLocal.set(id);
    }

    /**
     * 获取值
     * @return ThreadLocal 中的值
     */
    public static Long getCurrentId(){
        return threadLocal.get();
    }
}

```

> GlobalExceptionHandler

```java
/**
 * @ Name: GlobalExceptionHandler
 * @ Author: Cola
 * @ Time: 2022/12/27 20:13
 * @ Description: 全局异常处理
 */

@ControllerAdvice(annotations = {RestController.class, Controller.class})
@ResponseBody
@Slf4j
public class GlobalExceptionHandler {

    /**
     * 异常处理方法
     * @return R
     */
    @ExceptionHandler(SQLIntegrityConstraintViolationException.class)
    public R<String> exceptionHandler(@NotNull SQLIntegrityConstraintViolationException ex){
        log.error(ex.getMessage());

        if(ex.getMessage().contains("Duplicate entry")){
            String[] split = ex.getMessage().split(" ");
            String msg = split[2] + "已存在";
            return R.error(msg);
        }

        return R.error("未知错误");
    }

    /**
     * 异常处理方法
     * @return R
     */
    @ExceptionHandler(CustomException.class)
    public R<String> exceptionHandler(@NotNull CustomException ex){
        log.error(ex.getMessage());

        return R.error(ex.getMessage());
    }

}


```

> JacksonObjectMapper

```java
/**
 * @ Name: JacksonObjectMapper
 * @ Author: Cola
 * @ Time: 2022/12/27 18:00
 * @ Description: JacksonObjectMapper
 */
public class JacksonObjectMapper extends ObjectMapper {

    public static final String DEFAULT_DATE_FORMAT = "yyyy-MM-dd";
    public static final String DEFAULT_DATE_TIME_FORMAT = "yyyy-MM-dd HH:mm:ss";
    public static final String DEFAULT_TIME_FORMAT = "HH:mm:ss";

    public JacksonObjectMapper() {
        super();
        /*
        收到未知属性时不报异常
         */
        this.configure(FAIL_ON_UNKNOWN_PROPERTIES, false);

        /*
        反序列化时，属性不存在的兼容处理
         */
        this.getDeserializationConfig().withoutFeatures(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);


        SimpleModule simpleModule = new SimpleModule()
                .addDeserializer(LocalDateTime.class, new LocalDateTimeDeserializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT)))
                .addDeserializer(LocalDate.class, new LocalDateDeserializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT)))
                .addDeserializer(LocalTime.class, new LocalTimeDeserializer(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT)))

                .addSerializer(BigInteger.class, ToStringSerializer.instance)
                .addSerializer(Long.class, ToStringSerializer.instance)
                .addSerializer(LocalDateTime.class, new LocalDateTimeSerializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT)))
                .addSerializer(LocalDate.class, new LocalDateSerializer(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT)))
                .addSerializer(LocalTime.class, new LocalTimeSerializer(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT)));

        /*
        注册功能模块 例如，可以添加自定义序列化器和反序列化器
         */
        this.registerModule(simpleModule);
    }
}


```

> MyMetaObjectHandler

```java
/**
 * @ Name: MyMetaObjecthandler
 * @ Author: Cola
 * @ Time: 2022/12/27 20:12
 * @ Description: 自定义元数据对象处理器
 */
@Component
@Slf4j
public class MyMetaObjecthandler implements MetaObjectHandler {
    /**
     * 插入操作，自动填充
     * @param metaObject
     */
    @Override
    public void insertFill(@NotNull MetaObject metaObject) {
        log.info("公共字段自动填充[insert]...");
        log.info(metaObject.toString());

        metaObject.setValue("createTime", LocalDateTime.now());
        metaObject.setValue("updateTime",LocalDateTime.now());
        metaObject.setValue("createUser",BaseContext.getCurrentId());
        metaObject.setValue("updateUser",BaseContext.getCurrentId());
    }

    /**
     * 更新操作，自动填充
     * @param metaObject
     */
    @Override
    public void updateFill(@NotNull MetaObject metaObject) {
        log.info("公共字段自动填充[update]...");
        log.info(metaObject.toString());

        long id = Thread.currentThread().getId();
        log.info("线程id为：{}",id);

        metaObject.setValue("updateTime", LocalDateTime.now());
        metaObject.setValue("updateUser",BaseContext.getCurrentId());
    }
}

```

> SMSUtils

```java
/**
 * @ Name: SMSUtils
 * @ Author: Cola
 * @ Time: 2022/12/27 17:50
 * @ Description: 短信发送工具类
 */
public class SMSUtils {
    /**
     * 发送短信
     * @param signName 签名
     * @param templateCode 模板
     * @param phoneNumbers 手机号
     * @param param 参数
     */
    public static void sendMessage(String signName, String templateCode,String phoneNumbers,String param){
        DefaultProfile profile = DefaultProfile.getProfile("cn-hangzhou", "", "");
        IAcsClient client = new DefaultAcsClient(profile);

        SendSmsRequest request = new SendSmsRequest();
        request.setSysRegionId("cn-hangzhou");
        request.setPhoneNumbers(phoneNumbers);
        request.setSignName(signName);
        request.setTemplateCode(templateCode);
        request.setTemplateParam("{\"code\":\""+param+"\"}");
        try {
            SendSmsResponse response = client.getAcsResponse(request);
            System.out.println("短信发送成功");
        }catch (ClientException e) {
            e.printStackTrace();
        }
    }

}

```

> ValidateCodeUtils

```java
/**
 * @ Name: ValidateCodeUtils
 * @ Author: Cola
 * @ Time: 2022/12/27 17:49
 * @ Description: ValidateCodeUtils 随机生成验证码工具类
 */
public class ValidateCodeUtils {
    /**
     * 随机生成验证码
     * @param length 长度为4位或者6位
     * @return
     */
    public static Integer generateValidateCode(int length){
        Integer code =null;
        if(length == 4){
            code = new Random().nextInt(9999);//生成随机数，最大为9999
            if(code < 1000){
                code = code + 1000;//保证随机数为4位数字
            }
        }else if(length == 6){
            code = new Random().nextInt(999999);//生成随机数，最大为999999
            if(code < 100000){
                code = code + 100000;//保证随机数为6位数字
            }
        }else{
            throw new RuntimeException("只能生成4位或6位数字验证码");
        }
        return code;
    }

    /**
     * 随机生成指定长度字符串验证码
     * @param length 长度
     * @return
     */
    public static @NotNull String generateValidateCode4String(int length){
        Random rdm = new Random();
        String hash1 = Integer.toHexString(rdm.nextInt());
        String capstr = hash1.substring(0, length);
        return capstr;
    }
}

```

> CustomException

```java
/**
 * @ Name: CustomException
 * @ Author: Cola
 * @ Time: 2022/12/27 20:14
 * @ Description: 自定义业务异常类
 */
public class CustomException extends RuntimeException {
    public CustomException(String message){
        super(message);
    }
}

```



###### 1.2.2.2 controller 控制类

> config 配置类
>
> - [x] MyBatisPlusConfig
> - [x] WebMvcConfig

> MyBatisPlusConfig

```java
/**
 * @ Name: MybatisPlusConfig
 * @ Author: Cola
 * @ Time: 2022/12/27 20:10
 * @ Description: 配置 MP 的分页插件
 */
@Configuration
public class MybatisPlusConfig {
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor(){
        MybatisPlusInterceptor mybatisPlusInterceptor = new MybatisPlusInterceptor();
        mybatisPlusInterceptor.addInnerInterceptor(new PaginationInnerInterceptor());
        return mybatisPlusInterceptor;
    }
}

```

> WebMvcConfig

```java
/**
 * @ Name: WebMvcConfig
 * @ Author: Cola
 * @ Time: 2022/12/27 18:26
 * @ Description: WebMvcConfig
 */
@Configuration
@Slf4j
public class WebMvcConfig extends WebMvcConfigurationSupport {

    /**
     * 设置静态资源映射
     * @param registry
     */
    @Override
    protected void addResourceHandlers(ResourceHandlerRegistry registry) {
        log.info("开始进行静态资源映射...");
        registry.addResourceHandler("/backend/**").
                addResourceLocations("classpath:/backend/");
        registry.addResourceHandler("/front/**").
                addResourceLocations("classpath:/front/");
    }

    /**
     * 扩展mvc框架的消息转换器
     * @param converters
     */
    @Override
    protected void extendMessageConverters(List<HttpMessageConverter<?>> converters) {
        log.info("扩展消息转换器...");
        /*
        创建消息转换器对象
         */
        MappingJackson2HttpMessageConverter messageConverter = new MappingJackson2HttpMessageConverter();
        /*
        设置对象转换器，底层使用Jackson将Java对象转为json
         */
        messageConverter.setObjectMapper(new JacksonObjectMapper());
        /*
        将上面的消息转换器对象追加到mvc框架的转换器集合中
         */
        converters.add(0,messageConverter);
    }
}

```

> fitter 过滤器
>
> - [x] LoginCheckFitter

> LoginCheckFitter

```java
/**
 * @ Name: LoginCheckFilter
 * @ Author: Cola
 * @ Time: 2022/12/27 20:16
 * @ Description: 检查用户是否已经完成登录
 */
@WebFilter(filterName = "loginCheckFilter",urlPatterns = "/*")
@Slf4j
public class LoginCheckFilter implements Filter {
    /*
    路径匹配器，支持通配符
     */
    public static final AntPathMatcher PATH_MATCHER = new AntPathMatcher();

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {

        HttpServletRequest request = (HttpServletRequest) servletRequest;
        HttpServletResponse response = (HttpServletResponse) servletResponse;

        /*
        获取本次请求的URI
         */
        String requestURI = request.getRequestURI();

        log.info("拦截到请求：{}",requestURI);

        /*
        定义不需要处理的请求路径
         */
        String[] urls = new String[]{
                "/employee/login",
                "/employee/logout",
                "/backend/**",
                "/front/**",
                "/common/**",
                "/user/sendMsg",
                "/user/login"
        };

        /*
        判断本次请求是否需要处理
         */
        boolean check = check(urls, requestURI);

        /*
        如果不需要处理，则直接放行
         */
        if(check){
            log.info("本次请求{}不需要处理",requestURI);
            filterChain.doFilter(request,response);
            return;
        }

        /*
        判断 employee 登录状态，如果已登录，则直接放行
         */
        if(request.getSession().getAttribute("employee") != null){
            log.info("用户已登录，用户id为：{}",request.getSession().getAttribute("employee"));

            Long empId = (Long) request.getSession().getAttribute("employee");
            /*
            设置 CurrentId
             */
            BaseContext.setCurrentId(empId);

            filterChain.doFilter(request,response);
            return;
        }

        /*

        判断 user 登录状态，如果已登录，则直接放行
         */
        if(request.getSession().getAttribute("user") != null){
            log.info("用户已登录，用户id为：{}",request.getSession().getAttribute("user"));

            Long userId = (Long) request.getSession().getAttribute("user");
            /*
            设置 CurrentId
             */
            BaseContext.setCurrentId(userId);

            filterChain.doFilter(request,response);
            return;
        }

        log.info("用户未登录");
        /*
        如果未登录则返回未登录结果，通过输出流方式向客户端页面响应数据
         */
        response.getWriter().write(JSON.toJSONString(R.error("NOTLOGIN")));

    }

    /**
     * 路径匹配，检查本次请求是否需要放行
     * @param urls url 白名单
     * @param requestURI 当前 URL
     * @return 是否有权限
     */
    public boolean check(String @NotNull [] urls, String requestURI){
        for (String url : urls) {
            boolean match = PATH_MATCHER.match(url, requestURI);
            if(match){
                return true;
            }
        }
        return false;
    }

}

```



> 普通 controller

> - [x] AddressBookController
> - [x] CategoryController
> - [x] DishController
> - [x] EmployeeController
> - [x] OrderDetailController
> - [x] OdersController
> - [x] SetmealController
> - [x] ShoppingCartController
> - [x] UserController
> - [x] CommonController

> AddressBookController

```java
/**
 * @ Name: AddressBookController
 * @ Author: Cola
 * @ Time: 2022/12/27 23:47
 * @ Description: AddressBookController 地址簿管理
 */
@Slf4j
@RestController
@RequestMapping("/addressBook")
public class AddressBookController {

    @Autowired
    private AddressBookService addressBookService;

    /**
     * 新增
     */
    @PostMapping
    public R<AddressBook> save(@RequestBody AddressBook addressBook) {
        addressBook.setUserId(BaseContext.getCurrentId());
        log.info("addressBook:{}", addressBook);
        addressBookService.save(addressBook);
        return R.success(addressBook);
    }

    /**
     * 设置默认地址
     */
    @PutMapping("default")
    public R<AddressBook> setDefault(@RequestBody AddressBook addressBook) {
        log.info("addressBook:{}", addressBook);
        LambdaUpdateWrapper<AddressBook> wrapper = new LambdaUpdateWrapper<>();
        wrapper.eq(AddressBook::getUserId, BaseContext.getCurrentId());
        wrapper.set(AddressBook::getIsDefault, 0);
        //SQL:update address_book set is_default = 0 where user_id = ?
        addressBookService.update(wrapper);

        addressBook.setIsDefault(1);
        //SQL:update address_book set is_default = 1 where id = ?
        addressBookService.updateById(addressBook);
        return R.success(addressBook);
    }

    /**
     * 根据id查询地址
     */
    @GetMapping("/{id}")
    public R get(@PathVariable Long id) {
        AddressBook addressBook = addressBookService.getById(id);
        if (addressBook != null) {
            return R.success(addressBook);
        } else {
            return R.error("没有找到该对象");
        }
    }

    /**
     * 查询默认地址
     */
    @GetMapping("default")
    public R<AddressBook> getDefault() {
        LambdaQueryWrapper<AddressBook> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(AddressBook::getUserId, BaseContext.getCurrentId());
        queryWrapper.eq(AddressBook::getIsDefault, 1);

        //SQL:select * from address_book where user_id = ? and is_default = 1
        AddressBook addressBook = addressBookService.getOne(queryWrapper);

        if (null == addressBook) {
            return R.error("没有找到该对象");
        } else {
            return R.success(addressBook);
        }
    }

    /**
     * 查询指定用户的全部地址
     */
    @GetMapping("/list")
    public R<List<AddressBook>> list(AddressBook addressBook) {
        addressBook.setUserId(BaseContext.getCurrentId());
        log.info("addressBook:{}", addressBook);

        //条件构造器
        LambdaQueryWrapper<AddressBook> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(null != addressBook.getUserId(), AddressBook::getUserId, addressBook.getUserId());
        queryWrapper.orderByDesc(AddressBook::getUpdateTime);

        //SQL:select * from address_book where user_id = ? order by update_time desc
        return R.success(addressBookService.list(queryWrapper));
    }
}

```



> CategoryController

```java
/**
 * @ Name: CategoryController
 * @ Author: Cola
 * @ Time: 2022/12/27 23:49
 * @ Description: CategoryController 分类管理
 */

@RestController
@RequestMapping("/category")
@Slf4j
public class CategoryController {
    @Autowired
    private CategoryService categoryService;


    /**
     * 分页查询
     * @param page page
     * @param pageSize pageSize
     * @return R
     */
    @GetMapping("/page")
    public R<Page> page(Integer page, Integer pageSize){
        /*
        创建分页构造器和条件构造器
         */
        Page<Category> pageInfo = new Page<>(page,pageSize);
        LambdaQueryWrapper<Category> queryWrapper = new LambdaQueryWrapper<>();

        /*
        添加排序条件，根据 sort 进行排序
         */
        queryWrapper.orderByAsc(Category::getSort);

        /*
        进行查询
         */
        categoryService.page(pageInfo,queryWrapper);
        return R.success(pageInfo);
    }

    /**
     * 新增分类
     * @param category category
     * @return R
     */
    @PostMapping
    public R<String> save(@RequestBody Category category){
        log.info("category:{}",category);
        categoryService.save(category);
        return R.success("新增分类成功");
    }
    /**
     * 根据 id 删除分类 (删除前进行判断是否可以删除)
     * @param id id
     * @return R
     */
    @DeleteMapping
    public R<String> delete(Long id){
        log.info("删除分类，id为：{}",id);

        //categoryService.removeById(id);
        categoryService.remove(id);

        return R.success("分类信息删除成功");
    }

    /**
     * 根据id修改分类信息
     * @param category category
     * @return R
     */
    @PutMapping
    public R<String> update(@RequestBody Category category){
        log.info("修改分类信息：{}",category);

        categoryService.updateById(category);

        return R.success("修改分类信息成功");
    }

    /**
     * 根据条件查询分类数据
     * @param category category
     * @return R
     */
    @GetMapping("/list")
    public R<List<Category>> list(Category category){
        /*
        创建分页构造器和条件构造器
         */
        LambdaQueryWrapper<Category> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(category.getType() != null,Category::getType,category.getType());
        /*
        添加排序条件
         */
        queryWrapper.orderByAsc(Category::getSort).orderByDesc(Category::getUpdateTime);

        List<Category> list = categoryService.list(queryWrapper);
        return R.success(list);
    }

    @RequestMapping("/findAll")
    public List<Category> findAll(){
        return categoryService.list(null);
    }
}

```

> DishController

```java
/**
 * @ Name: DishController
 * @ Author: Cola
 * @ Time: 2022/12/27 23:54
 * @ Description: DishController 菜品管理
 */
@RestController
@RequestMapping("/dish")
@Slf4j
public class DishController {
    @Autowired
    private DishService dishService;

    @Autowired
    private DishFlavorService dishFlavorService;

    @Autowired
    private CategoryService categoryService;

    /**
     * 新增菜品
     * @param dishDto
     * @return
     */
    @PostMapping
    public R<String> save(@RequestBody DishDto dishDto){
        log.info(dishDto.toString());

        dishService.saveWithFlavor(dishDto);

        return R.success("新增菜品成功");
    }

    /**
     * 菜品信息分页查询
     * @param page
     * @param pageSize
     * @param name
     * @return
     */
    @GetMapping("/page")
    public R<Page> page(int page, int pageSize, String name){

        //构造分页构造器对象
        Page<Dish> pageInfo = new Page<>(page,pageSize);
        Page<DishDto> dishDtoPage = new Page<>();

        //条件构造器
        LambdaQueryWrapper<Dish> queryWrapper = new LambdaQueryWrapper<>();
        //添加过滤条件
        queryWrapper.like(name != null,Dish::getName,name);
        //添加排序条件
        queryWrapper.orderByDesc(Dish::getUpdateTime);

        //执行分页查询
        dishService.page(pageInfo,queryWrapper);

        //对象拷贝
        BeanUtils.copyProperties(pageInfo,dishDtoPage,"records");

        List<Dish> records = pageInfo.getRecords();

        List<DishDto> list = records.stream().map((item) -> {
            DishDto dishDto = new DishDto();

            BeanUtils.copyProperties(item,dishDto);

            Long categoryId = item.getCategoryId();//分类id
            //根据id查询分类对象
            Category category = categoryService.getById(categoryId);

            if(category != null){
                String categoryName = category.getName();
                dishDto.setCategoryName(categoryName);
            }
            return dishDto;
        }).collect(Collectors.toList());

        dishDtoPage.setRecords(list);

        return R.success(dishDtoPage);
    }

    /**
     * 根据id查询菜品信息和对应的口味信息
     * @param id
     * @return
     */
    @GetMapping("/{id}")
    public R<DishDto> get(@PathVariable Long id){

        DishDto dishDto = dishService.getByIdWithFlavor(id);

        return R.success(dishDto);
    }

    /**
     * 修改菜品
     * @param dishDto
     * @return
     */
    @PutMapping
    public R<String> update(@RequestBody DishDto dishDto){
        log.info(dishDto.toString());

        dishService.updateWithFlavor(dishDto);

        return R.success("修改菜品成功");
    }

    /**
     * 根据条件查询对应的菜品数据
     * @param dish
     * @return
     */
    /*@GetMapping("/list")
    public R<List<Dish>> list(Dish dish){
        //构造查询条件
        LambdaQueryWrapper<Dish> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(dish.getCategoryId() != null ,Dish::getCategoryId,dish.getCategoryId());
        //添加条件，查询状态为1（起售状态）的菜品
        queryWrapper.eq(Dish::getStatus,1);

        //添加排序条件
        queryWrapper.orderByAsc(Dish::getSort).orderByDesc(Dish::getUpdateTime);

        List<Dish> list = dishService.list(queryWrapper);

        return R.success(list);
    }*/

    @GetMapping("/list")
    public R<List<DishDto>> list(Dish dish){
        //构造查询条件
        LambdaQueryWrapper<Dish> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(dish.getCategoryId() != null ,Dish::getCategoryId,dish.getCategoryId());
        //添加条件，查询状态为1（起售状态）的菜品
        queryWrapper.eq(Dish::getStatus,1);

        //添加排序条件
        queryWrapper.orderByAsc(Dish::getSort).orderByDesc(Dish::getUpdateTime);

        List<Dish> list = dishService.list(queryWrapper);

        List<DishDto> dishDtoList = list.stream().map((item) -> {
            DishDto dishDto = new DishDto();

            BeanUtils.copyProperties(item,dishDto);

            Long categoryId = item.getCategoryId();//分类id
            //根据id查询分类对象
            Category category = categoryService.getById(categoryId);

            if(category != null){
                String categoryName = category.getName();
                dishDto.setCategoryName(categoryName);
            }

            //当前菜品的id
            Long dishId = item.getId();
            LambdaQueryWrapper<DishFlavor> lambdaQueryWrapper = new LambdaQueryWrapper<>();
            lambdaQueryWrapper.eq(DishFlavor::getDishId,dishId);
            //SQL:select * from dish_flavor where dish_id = ?
            List<DishFlavor> dishFlavorList = dishFlavorService.list(lambdaQueryWrapper);
            dishDto.setFlavors(dishFlavorList);
            return dishDto;
        }).collect(Collectors.toList());

        return R.success(dishDtoList);
    }

}


```

> EmployeeController

```java
/**
 * @ Name: EmployeeController
 * @ Author: Cola
 * @ Time: 2022/12/27 18:13
 * @ Description: EmployeeController
 */
@RestController
@RequestMapping("/employee")
@Slf4j
public class EmployeeController {

    @Autowired
    EmployeeService employeeService;


    /**
     * 员工登录
     * @param request request
     * @param employee employee
     * @return R
     */
    @PostMapping("/login")
    public R<Employee> login(HttpServletRequest request, @RequestBody Employee employee){

        /*
        将页面提交的密码password进行md5加密处理
         */
        String password = employee.getPassword();
        password = DigestUtils.md5DigestAsHex(password.getBytes());

        /*
        根据页面提交的用户名username查询数据库
         */
        LambdaQueryWrapper<Employee> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(Employee::getUsername,employee.getUsername());
        Employee emp = employeeService.getOne(queryWrapper);

        /*
        如果没有查询到则返回登录失败结果
         */
        if(emp == null){
            return R.error("登录失败");
        }

        /*
        密码比对，如果不一致则返回登录失败结果
         */
        if(!emp.getPassword().equals(password)){
            return R.error("登录失败");
        }

        /*
        查看员工状态，如果为已禁用状态，则返回员工已禁用结果
         */
        if(emp.getStatus() == 0){
            return R.error("账号已禁用");
        }

        /*
        登录成功，将员工id存入Session并返回登录成功结果
         */
        request.getSession().setAttribute("employee",emp.getId());

        return R.success(emp);
    }

    /**
     * 员工退出
     * @param request request
     * @return R
     */
    @PostMapping("/logout")
    public R<String> logout(HttpServletRequest request){
        /*
        清理Session中保存的当前登录员工的id
         */
        request.getSession().removeAttribute("employee");
        return R.success("退出成功");
    }

    /**
     * 新增员工
     * @param employee employee
     * @return R
     */
    @PostMapping
    public R<String> save(HttpServletRequest request,@RequestBody Employee employee){
        log.info("新增员工，员工信息：{}",employee.toString());

        /*
        设置初始密码123456，需要进行md5加密处理
         */
        employee.setPassword(DigestUtils.md5DigestAsHex("123456".getBytes()));


        employeeService.save(employee);

        return R.success("新增员工成功");
    }

    /**
     * 员工信息分页查询
     * @param page page
     * @param pageSize pageSize
     * @param name name
     * @return R
     */
    @GetMapping("/page")
    public R<Page> page(int page,int pageSize,String name){
        log.info("page = {},pageSize = {},name = {}" ,page,pageSize,name);

        /*
        构造分页构造器
         */
        Page pageInfo = new Page(page,pageSize);

        /*
        构造条件构造器
         */
        LambdaQueryWrapper<Employee> queryWrapper = new LambdaQueryWrapper();
        /*
        添加过滤条件并执行查询
         */
        queryWrapper.like(StringUtils.isNotEmpty(name),Employee::getName,name);
        queryWrapper.orderByDesc(Employee::getUpdateTime);
        employeeService.page(pageInfo,queryWrapper);

        return R.success(pageInfo);
    }

    /**
     * 根据id修改员工信息
     * @param employee employee
     * @return R
     */
    @PutMapping
    public R<String> update(HttpServletRequest request,@RequestBody Employee employee){

        employeeService.updateById(employee);

        return R.success("员工信息修改成功");
    }

    /**
     * 根据id查询员工信息
     * @param id id
     * @return R
     */
    @GetMapping("/{id}")
    public R<Employee> getById(@PathVariable Long id){
        log.info("根据id查询员工信息");
        Employee employee = employeeService.getById(id);
        if(employee != null){
            return R.success(employee);
        }
        return R.error("没有查询到对应员工信息");
    }
}

```

> OrderDetailController

```java
/**
 * @ Name: OrderDetailController
 * @ Author: Cola
 * @ Time: 2022/12/27 23:58
 * @ Description: OrderDetailController 订单明细
 */
@Slf4j
@RestController
@RequestMapping("/orderDetail")
public class OrderDetailController {
    @Autowired
    private OrderDetailService orderDetailService;
}

```

> OdersController

```java
/**
 * @ Name: OrderController
 * @ Author: Cola
 * @ Time: 2022/12/27 23:41
 * @ Description: OrderController
 */
@RestController
@RequestMapping("/order")
@Slf4j
public class OrderController {
    @Autowired
    private OrdersService ordersService;

    /**
     * 用户下单
     * @param orders orders
     * @return R
     */
    @PostMapping("/submit")
    public R<String> submit(@RequestBody Orders orders){
        log.info("订单数据：{}",orders);
        ordersService.submit(orders);
        return R.success("下单成功");
    }

    /**
     * 分页查询
     * @param page
     * @param pageSize
     * @return
     */
    @GetMapping("/page")
    public R<Page> page(int page, int pageSize){
        //分页构造器
        Page<Orders> pageInfo = new Page<>(page,pageSize);
        //条件构造器
        LambdaQueryWrapper<Orders> queryWrapper = new LambdaQueryWrapper<>();

        //分页查询
        ordersService.page(pageInfo, queryWrapper);
        return R.success(pageInfo);
    }
}

```

> SetmealController

```java
/**
 * @ Name: SetmealController
 * @ Author: Cola
 * @ Time: 2022/12/27 23:59
 * @ Description: SetmealController 套餐管理
 */
@RestController
@RequestMapping("/setmeal")
@Slf4j
public class SetmealController {
    @Autowired
    private SetmealService setmealService;

    @Autowired
    private CategoryService categoryService;

    @Autowired
    private SetmealDishService setmealDishService;

    /**
     * 新增套餐
     * @param setmealDto
     * @return
     */
    @PostMapping
    public R<String> save(@RequestBody SetmealDto setmealDto){
        log.info("套餐信息：{}",setmealDto);

        setmealService.saveWithDish(setmealDto);

        return R.success("新增套餐成功");
    }

    /**
     * 套餐分页查询
     * @param page
     * @param pageSize
     * @param name
     * @return
     */
    @GetMapping("/page")
    public R<Page> page(int page, int pageSize, String name){
        //分页构造器对象
        Page<Setmeal> pageInfo = new Page<>(page,pageSize);
        Page<SetmealDto> dtoPage = new Page<>();

        LambdaQueryWrapper<Setmeal> queryWrapper = new LambdaQueryWrapper<>();
        //添加查询条件，根据name进行like模糊查询
        queryWrapper.like(name != null,Setmeal::getName,name);
        //添加排序条件，根据更新时间降序排列
        queryWrapper.orderByDesc(Setmeal::getUpdateTime);

        setmealService.page(pageInfo,queryWrapper);

        //对象拷贝
        BeanUtils.copyProperties(pageInfo,dtoPage,"records");
        List<Setmeal> records = pageInfo.getRecords();

        List<SetmealDto> list = records.stream().map((item) -> {
            SetmealDto setmealDto = new SetmealDto();
            //对象拷贝
            BeanUtils.copyProperties(item,setmealDto);
            //分类id
            Long categoryId = item.getCategoryId();
            //根据分类id查询分类对象
            Category category = categoryService.getById(categoryId);
            if(category != null){
                //分类名称
                String categoryName = category.getName();
                setmealDto.setCategoryName(categoryName);
            }
            return setmealDto;
        }).collect(Collectors.toList());

        dtoPage.setRecords(list);
        return R.success(dtoPage);
    }

    /**
     * 删除套餐
     * @param ids
     * @return
     */
    @DeleteMapping
    public R<String> delete(@RequestParam List<Long> ids){
        log.info("ids:{}",ids);

        setmealService.removeWithDish(ids);

        return R.success("套餐数据删除成功");
    }

    /**
     * 根据条件查询套餐数据
     * @param setmeal
     * @return
     */
    @GetMapping("/list")
    public R<List<Setmeal>> list(Setmeal setmeal){
        LambdaQueryWrapper<Setmeal> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(setmeal.getCategoryId() != null,Setmeal::getCategoryId,setmeal.getCategoryId());
        queryWrapper.eq(setmeal.getStatus() != null,Setmeal::getStatus,setmeal.getStatus());
        queryWrapper.orderByDesc(Setmeal::getUpdateTime);

        List<Setmeal> list = setmealService.list(queryWrapper);

        return R.success(list);
    }
}

```

> ShoppingCartController

```java
/**
 * @ Name: ShoppingCartController
 * @ Author: Cola
 * @ Time: 2022/12/28 0:02
 * @ Description: ShoppingCartController 购物车
 */
@Slf4j
@RestController
@RequestMapping("/shoppingCart")
public class ShoppingCartController {

    @Autowired
    private ShoppingCartService shoppingCartService;

    /**
     * 添加购物车
     * @param shoppingCart
     * @return
     */
    @PostMapping("/add")
    public R<ShoppingCart> add(@RequestBody ShoppingCart shoppingCart){
        log.info("购物车数据:{}",shoppingCart);

        //设置用户id，指定当前是哪个用户的购物车数据
        Long currentId = BaseContext.getCurrentId();
        shoppingCart.setUserId(currentId);

        Long dishId = shoppingCart.getDishId();

        LambdaQueryWrapper<ShoppingCart> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(ShoppingCart::getUserId,currentId);

        if(dishId != null){
            //添加到购物车的是菜品
            queryWrapper.eq(ShoppingCart::getDishId,dishId);

        }else{
            //添加到购物车的是套餐
            queryWrapper.eq(ShoppingCart::getSetmealId,shoppingCart.getSetmealId());
        }

        //查询当前菜品或者套餐是否在购物车中
        //SQL:select * from shopping_cart where user_id = ? and dish_id/setmeal_id = ?
        ShoppingCart cartServiceOne = shoppingCartService.getOne(queryWrapper);

        if(cartServiceOne != null){
            //如果已经存在，就在原来数量基础上加一
            Integer number = cartServiceOne.getNumber();
            cartServiceOne.setNumber(number + 1);
            shoppingCartService.updateById(cartServiceOne);
        }else{
            //如果不存在，则添加到购物车，数量默认就是一
            shoppingCart.setNumber(1);
            shoppingCart.setCreateTime(LocalDateTime.now());
            shoppingCartService.save(shoppingCart);
            cartServiceOne = shoppingCart;
        }

        return R.success(cartServiceOne);
    }

    /**
     * 查看购物车
     * @return
     */
    @GetMapping("/list")
    public R<List<ShoppingCart>> list(){
        log.info("查看购物车...");

        LambdaQueryWrapper<ShoppingCart> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(ShoppingCart::getUserId,BaseContext.getCurrentId());
        queryWrapper.orderByAsc(ShoppingCart::getCreateTime);

        List<ShoppingCart> list = shoppingCartService.list(queryWrapper);

        return R.success(list);
    }

    /**
     * 清空购物车
     * @return
     */
    @DeleteMapping("/clean")
    public R<String> clean(){
        //SQL:delete from shopping_cart where user_id = ?

        LambdaQueryWrapper<ShoppingCart> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(ShoppingCart::getUserId,BaseContext.getCurrentId());

        shoppingCartService.remove(queryWrapper);

        return R.success("清空购物车成功");
    }
}

```

> UserController

```java
/**
 * @ Name: UserController
 * @ Author: Cola
 * @ Time: 2022/12/28 0:03
 * @ Description: UserController
 */
@RestController
@RequestMapping("/user")
@Slf4j
public class UserController {

    @Autowired
    private UserService userService;

    /**
     * 发送手机短信验证码
     * @param user
     * @return
     */
    @PostMapping("/sendMsg")
    public R<String> sendMsg(@RequestBody User user, HttpSession session){
        //获取手机号
        String phone = user.getPhone();

        if(StringUtils.isNotEmpty(phone)){
            //生成随机的4位验证码
            String code = ValidateCodeUtils.generateValidateCode(4).toString();
            log.info("code={}",code);

            //调用阿里云提供的短信服务API完成发送短信
            //SMSUtils.sendMessage("瑞吉外卖","",phone,code);

            //需要将生成的验证码保存到Session
            session.setAttribute(phone,code);

            return R.success("手机验证码短信发送成功");
        }

        return R.error("短信发送失败");
    }

    /**
     * 移动端用户登录
     * @param map
     * @param session
     * @return
     */
    @PostMapping("/login")
    public R<User> login(@RequestBody Map map, HttpSession session){
        log.info(map.toString());

        //获取手机号
        String phone = map.get("phone").toString();

        //获取验证码
        String code = map.get("code").toString();

        //从Session中获取保存的验证码
        Object codeInSession = session.getAttribute(phone);

        //进行验证码的比对（页面提交的验证码和Session中保存的验证码比对）
        if(codeInSession != null && codeInSession.equals(code)){
            //如果能够比对成功，说明登录成功

            LambdaQueryWrapper<User> queryWrapper = new LambdaQueryWrapper<>();
            queryWrapper.eq(User::getPhone,phone);

            User user = userService.getOne(queryWrapper);
            if(user == null){
                //判断当前手机号对应的用户是否为新用户，如果是新用户就自动完成注册
                user = new User();
                user.setPhone(phone);
                user.setStatus(1);
                userService.save(user);
            }
            session.setAttribute("user",user.getId());
            return R.success(user);
        }
        return R.error("登录失败");
    }

}

```

> CommonController

```java
/**
 * @ Name: CommonController
 * @ Author: Cola
 * @ Time: 2022/12/27 23:53
 * @ Description: CommonController 文件上传和下载
 */
@RestController
@RequestMapping("/common")
@Slf4j
public class CommonController {

    @Value("${reggie.path}")
    private String basePath;

    /**
     * 文件上传
     * @param file
     * @return
     */
    @PostMapping("/upload")
    public R<String> upload(MultipartFile file){
        //file是一个临时文件，需要转存到指定位置，否则本次请求完成后临时文件会删除
        log.info(file.toString());

        //原始文件名
        String originalFilename = file.getOriginalFilename();//abc.jpg
        String suffix = originalFilename.substring(originalFilename.lastIndexOf("."));

        //使用UUID重新生成文件名，防止文件名称重复造成文件覆盖
        String fileName = UUID.randomUUID().toString() + suffix;//dfsdfdfd.jpg

        //创建一个目录对象
        File dir = new File(basePath);
        //判断当前目录是否存在
        if(!dir.exists()){
            //目录不存在，需要创建
            dir.mkdirs();
        }

        try {
            //将临时文件转存到指定位置
            file.transferTo(new File(basePath + fileName));
        } catch (IOException e) {
            e.printStackTrace();
        }
        return R.success(fileName);
    }

    /**
     * 文件下载
     * @param name
     * @param response
     */
    @GetMapping("/download")
    public void download(String name, HttpServletResponse response){

        try {
            //输入流，通过输入流读取文件内容
            FileInputStream fileInputStream = new FileInputStream(new File(basePath + name));

            //输出流，通过输出流将文件写回浏览器
            ServletOutputStream outputStream = response.getOutputStream();

            response.setContentType("image/jpeg");

            int len = 0;
            byte[] bytes = new byte[1024];
            while ((len = fileInputStream.read(bytes)) != -1){
                outputStream.write(bytes,0,len);
                outputStream.flush();
            }

            //关闭资源
            outputStream.close();
            fileInputStream.close();
        } catch (Exception e) {
            e.printStackTrace();
        }

    }
}


```



###### 1.2.2.3 domain 实体类

> - [x] AddressBook 地址簿类
> - [x] Category  菜品套餐类
> - [x] Dish 菜品类
> - [x] DishFlavor 菜品口味类
> - [x] Employee 员工类
> - [x] OrderDetail 订单明细类
> - [x] Oders 订单类
> - [x] Setmeal 套餐类
> - [x] SetmealDish 套餐菜品关系
> - [x] ShoppingCart 购物车类
> - [x] User 用户类
> - [x] 实体集 R

---

> AddressBook 地址簿类

```java
/**
 * @ Name: AddressBook
 * @ Author: Cola
 * @ Time: 2022/12/27 17:40
 * @ Description: AddressBook 地址簿
 */
@Data
public class AddressBook implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long id;


    //用户id
    private Long userId;


    //收货人
    private String consignee;


    //手机号
    private String phone;


    //性别 0 女 1 男
    private String sex;


    //省级区划编号
    private String provinceCode;


    //省级名称
    private String provinceName;


    //市级区划编号
    private String cityCode;


    //市级名称
    private String cityName;


    //区级区划编号
    private String districtCode;


    //区级名称
    private String districtName;


    //详细地址
    private String detail;


    //标签
    private String label;

    //是否默认 0 否 1是
    private Integer isDefault;

    //创建时间
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;


    //更新时间
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;


    //创建人
    @TableField(fill = FieldFill.INSERT)
    private Long createUser;


    //修改人
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private Long updateUser;


    //是否删除
    private Integer isDeleted;
}

```

> Category  菜品套餐类

```java
/**
 * @ Name: Category
 * @ Author: Cola
 * @ Time: 2022/12/27 17:40
 * @ Description: Category
 */
@Data
public class Category implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long id;


    //类型 1 菜品分类 2 套餐分类
    private Integer type;


    //分类名称
    private String name;


    //顺序
    private Integer sort;


    //创建时间
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;


    //更新时间
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;


    //创建人
    @TableField(fill = FieldFill.INSERT)
    private Long createUser;


    //修改人
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private Long updateUser;


    //是否删除
    private Integer isDeleted;

}

```

> Dish 菜品类

```java
/**
 * @ Name: Dish
 * @ Author: Cola
 * @ Time: 2022/12/27 17:41
 * @ Description: Dish
 */
@Data
public class Dish implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long id;


    //菜品名称
    private String name;


    //菜品分类id
    private Long categoryId;


    //菜品价格
    private BigDecimal price;


    //商品码
    private String code;


    //图片
    private String image;


    //描述信息
    private String description;


    //0 停售 1 起售
    private Integer status;


    //顺序
    private Integer sort;


    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;


    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;


    @TableField(fill = FieldFill.INSERT)
    private Long createUser;


    @TableField(fill = FieldFill.INSERT_UPDATE)
    private Long updateUser;


    //是否删除
    private Integer isDeleted;

}

```

> DishFlavor 菜品口味类

```java
/**
 * @ Name: DishFlavor
 * @ Author: Cola
 * @ Time: 2022/12/27 17:42
 * @ Description: DishFlavor
 */
@Data
public class DishFlavor implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long id;


    //菜品id
    private Long dishId;


    //口味名称
    private String name;


    //口味数据list
    private String value;


    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;


    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;


    @TableField(fill = FieldFill.INSERT)
    private Long createUser;


    @TableField(fill = FieldFill.INSERT_UPDATE)
    private Long updateUser;


    //是否删除
    private Integer isDeleted;
}

```

> Employee 员工类

```java
/**
 * @ Name: Employee
 * @ Author: Cola
 * @ Time: 2022/12/27 17:42
 * @ Description: Employee
 */
@Data
public class Employee implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long id;

    private String username;

    private String name;

    private String password;

    private String phone;

    private String sex;

    private String idNumber;

    private Integer status;

    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;

    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;

    @TableField(fill = FieldFill.INSERT)
    private Long createUser;

    @TableField(fill = FieldFill.INSERT_UPDATE)
    private Long updateUser;

}

```

> OrderDetail 订单明细类

```java
/**
 * @ Name: OrderDetail
 * @ Author: Cola
 * @ Time: 2022/12/27 17:42
 * @ Description: OrderDetail
 */
@Data
public class OrderDetail implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long id;

    //名称
    private String name;

    //订单id
    private Long orderId;


    //菜品id
    private Long dishId;


    //套餐id
    private Long setmealId;


    //口味
    private String dishFlavor;


    //数量
    private Integer number;

    //金额
    private BigDecimal amount;

    //图片
    private String image;
}

```

> Oders 订单类

```java
/**
 * @ Name: Orders
 * @ Author: Cola
 * @ Time: 2022/12/27 17:43
 * @ Description: Orders
 */
@Data
public class Orders implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long id;

    //订单号
    private String number;

    //订单状态 1待付款，2待派送，3已派送，4已完成，5已取消
    private Integer status;


    //下单用户id
    private Long userId;

    //地址id
    private Long addressBookId;


    //下单时间
    private LocalDateTime orderTime;


    //结账时间
    private LocalDateTime checkoutTime;


    //支付方式 1微信，2支付宝
    private Integer payMethod;


    //实收金额
    private BigDecimal amount;

    //备注
    private String remark;

    //用户名
    private String userName;

    //手机号
    private String phone;

    //地址
    private String address;

    //收货人
    private String consignee;
}

```

> Setmeal 套餐类

```java
/**
 * @ Name: Setmeal
 * @ Author: Cola
 * @ Time: 2022/12/27 17:43
 * @ Description: Setmeal
 */
@Data
public class Setmeal implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long id;


    //分类id
    private Long categoryId;


    //套餐名称
    private String name;


    //套餐价格
    private BigDecimal price;


    //状态 0:停用 1:启用
    private Integer status;


    //编码
    private String code;


    //描述信息
    private String description;


    //图片
    private String image;


    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;


    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;


    @TableField(fill = FieldFill.INSERT)
    private Long createUser;


    @TableField(fill = FieldFill.INSERT_UPDATE)
    private Long updateUser;


    //是否删除
    private Integer isDeleted;
}

```

> SetmealDish 套餐菜品关系

```java
/**
 * @ Name: SetmealDish
 * @ Author: Cola
 * @ Time: 2022/12/27 17:44
 * @ Description: SetmealDish
 */
@Data
public class SetmealDish implements Serializable {

    private static final long serialVersionUID = 1L;

    private Long id;


    //套餐id
    private Long setmealId;


    //菜品id
    private Long dishId;


    //菜品名称 （冗余字段）
    private String name;

    //菜品原价
    private BigDecimal price;

    //份数
    private Integer copies;


    //排序
    private Integer sort;


    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;


    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;


    @TableField(fill = FieldFill.INSERT)
    private Long createUser;


    @TableField(fill = FieldFill.INSERT_UPDATE)
    private Long updateUser;


    //是否删除
    private Integer isDeleted;
}

```

> ShoppingCart 购物车类

```java
/**
 * @ Name: ShoppingCart
 * @ Author: Cola
 * @ Time: 2022/12/27 17:39
 * @ Description: ShoppingCart
 */
@Data
public class ShoppingCart implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long id;

    //名称
    private String name;

    //用户id
    private Long userId;

    //菜品id
    private Long dishId;

    //套餐id
    private Long setmealId;

    //口味
    private String dishFlavor;

    //数量
    private Integer number;

    //金额
    private BigDecimal amount;

    //图片
    private String image;

    private LocalDateTime createTime;
}

```

> User 用户类

```java
/**
 * @ Name: User
 * @ Author: Cola
 * @ Time: 2022/12/27 17:38
 * @ Description: User
 */
@Data
public class User implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long id;


    //姓名
    private String name;


    //手机号
    private String phone;


    //性别 0 女 1 男
    private String sex;


    //身份证号
    private String idNumber;


    //头像
    private String avatar;


    //状态 0:禁用，1:正常
    private Integer status;
}

```

> 实体集 R

```java
/**
 * @ Name: R
 * @ Author: Cola
 * @ Time: 2022/12/27 17:47
 * @ Description: R 结果集
 */
@Data
public class R<T> {

    private Integer code; //编码：1成功，0和其它数字为失败

    private String msg; //错误信息

    private T data; //数据

    private Map map = new HashMap(); //动态数据

    public static <T> R<T> success(T object) {
        R<T> r = new R<T>();
        r.data = object;
        r.code = 1;
        return r;
    }

    public static <T> R<T> error(String msg) {
        R r = new R();
        r.msg = msg;
        r.code = 0;
        return r;
    }

    public R<T> add(String key, Object value) {
        this.map.put(key, value);
        return this;
    }
}

```

###### 1.2.2.4 dto 数据类

>  dto 数据类
>
>  - [x] DishDto
>  - [x] OrdersDto
>  - [x] SetmealDto

> DishDto

```java
/**
 * @ Name: DishDto
 * @ Author: Cola
 * @ Time: 2022/12/27 17:45
 * @ Description: DishDto
 */
@Data
public class DishDto extends Dish {
    private List<DishFlavor> flavors = new ArrayList<>();

    private String categoryName;

    private Integer copies;
}

```

> OrdersDto

```java
/**
 * @ Name: OrdersDto
 * @ Author: Cola
 * @ Time: 2022/12/27 17:45
 * @ Description: OrdersDto
 */
@Data
public class OrdersDto extends Orders {
    private String userName;

    private String phone;

    private String address;

    private String consignee;

    private List<OrderDetail> orderDetails;
}

```

> SetmealDto

```java
/**
 * @ Name: SetmealDto
 * @ Author: Cola
 * @ Time: 2022/12/27 17:44
 * @ Description: SetmealDto
 */
@Data
public class SetmealDto extends Setmeal {
    private List<SetmealDish> setmealDishes;

    private String categoryName;
}
```

###### 1.2.2.5 mapper

> - [x] AddressBookMapper 
> - [x] CategoryMapper   
> - [x] DishMapper  
> - [x] DishFlavorMapper  
> - [x] EmployeeMapper  
> - [x] OrderDetailMapper  
> - [x] OdersMapper  
> - [x] SetmealMapper  
> - [x] SetmealDishMapper  
> - [x] ShoppingCartMapper  
> - [x] UserMapper  

> AddressBookMapper 

```java
/**
 * @ Name: AddressBook
 * @ Author: Cola
 * @ Time: 2022/12/27 19:38
 * @ Description: AddressBook
 */
@Mapper
public interface AddressBookMapper extends BaseMapper<AddressBook> {
}

```

> CategoryMapper   

```java
/**
 * @ Name: CategoryMapper
 * @ Author: Cola
 * @ Time: 2022/12/27 19:32
 * @ Description: CategoryMapper
 */
@Mapper
public interface CategoryMapper extends BaseMapper<Category> {
}

```

> DishMapper  

```java
/**
 * @ Name: DishMapper
 * @ Author: Cola
 * @ Time: 2022/12/27 19:40
 * @ Description: DishMapper
 */
@Mapper
public interface DishMapper extends BaseMapper<Dish> {
}

```

> DishFlavorMapper  

```java
/**
 * @ Name: DishFlavorMapper
 * @ Author: Cola
 * @ Time: 2022/12/27 19:42
 * @ Description: DishFlavorMapper
 */
@Mapper
public interface DishFlavorMapper extends BaseMapper<DishFlavor> {
}

```

> EmployeeMapper  

```java
/**
 * @ Name: EmployeeMapper
 * @ Author: Cola
 * @ Time: 2022/12/27 19:44
 * @ Description: EmployeeMapper
 */
@Mapper
public interface EmployeeMapper extends BaseMapper<Employee> {
}

```

> OrderDetailMapper  

```java
/**
 * @ Name: OrderDetailMapper
 * @ Author: Cola
 * @ Time: 2022/12/27 19:45
 * @ Description: OrderDetailMapper
 */
@Mapper
public interface OrderDetailMapper extends BaseMapper<OrderDetail> {
}

```

> OdersMapper  

```java
/**
 * @ Name: OrdersMapper
 * @ Author: Cola
 * @ Time: 2022/12/27 19:46
 * @ Description: OrdersMapper
 */
@Mapper
public interface OrdersMapper extends BaseMapper<Orders> {
}

```

> SetmealMapper  

```java
/**
 * @ Name: SetmealDishMapper
 * @ Author: Cola
 * @ Time: 2022/12/27 19:50
 * @ Description: SetmealDishMapper
 */
@Mapper
public interface SetmealDishMapper extends BaseMapper<SetmealDish> {
}

```

> SetmealDishMapper  

```java
/**
 * @ Name: SetmealMapper
 * @ Author: Cola
 * @ Time: 2022/12/27 19:48
 * @ Description: SetmealMapper
 */
@Mapper
public interface SetmealMapper extends BaseMapper<Setmeal> {
}

```

> ShoppingCartMapper  

```java
/**
 * @ Name: ShoppingCartMapper
 * @ Author: Cola
 * @ Time: 2022/12/27 19:51
 * @ Description: ShoppingCartMapper
 */
@Mapper
public interface ShoppingCartMapper extends BaseMapper<ShoppingCart> {
}

```

> UserMapper  

```java
/**
 * @ Name: UserMapper
 * @ Author: Cola
 * @ Time: 2022/12/27 19:52
 * @ Description: UserMapper
 */
@Mapper
public interface UserMapper extends BaseMapper<User> {
}
```


###### 1.2.2.6 service

> - [x] AddressBookService
> - [x] CategoryService
> - [x] DishService
> - [x] DishFlavorService
> - [x] EmployeeService
> - [x] OrderDetailService
> - [x] OdersService
> - [x] SetmealService
> - [x] SetmealDishService
> - [x] ShoppingCartService
> - [x] UserService

> AddressBookService

```java
/**
 * @ Name: AddressBookService
 * @ Author: Cola
 * @ Time: 2022/12/27 19:39
 * @ Description: AddressBookService
 */
public interface AddressBookService extends IService<AddressBook> {
}

```

```java
/**
 * @ Name: AddressBookServiceImpl
 * @ Author: Cola
 * @ Time: 2022/12/27 19:40
 * @ Description: AddressBookServiceImpl
 */
@Service
public class AddressBookServiceImpl extends ServiceImpl<AddressBookMapper, AddressBook> implements AddressBookService {
}

```

> CategoryService

```java
/**
 * @ Name: CategoryService
 * @ Author: Cola
 * @ Time: 2022/12/27 19:33
 * @ Description: CategoryService
 */
public interface CategoryService extends IService<Category> {
    /**
     * 判断是否可以删除
     * @param id id
     */
    public void remove(Long id);
}

```

```java
/**
 * @ Name: CategoryServiceImpl
 * @ Author: Cola
 * @ Time: 2022/12/27 19:34
 * @ Description: CategoryServiceImpl
 */
@Service
public class CategoryServiceImpl extends ServiceImpl<CategoryMapper, Category> implements CategoryService {
    @Autowired
    private DishService dishService;

    @Autowired
    private SetmealService setmealService;

    /**
     * 根据 id 删除分类，删除之前需要进行判断
     * @param id id
     */
    @Override
    public void remove(Long id) {
        LambdaQueryWrapper<Dish> dishLambdaQueryWrapper = new LambdaQueryWrapper<>();
        // 添加查询条件，根据分类id进行查询
        dishLambdaQueryWrapper.eq(Dish::getCategoryId,id);
        int count1 = dishService.count(dishLambdaQueryWrapper);

        //查询当前分类是否关联了菜品，如果已经关联，抛出一个业务异常
        if(count1 > 0){
            //已经关联菜品，抛出一个业务异常
            throw new CustomException("当前分类下关联了菜品，不能删除");
        }

        // 查询当前分类是否关联了套餐，如果已经关联，抛出一个业务异常
        LambdaQueryWrapper<Setmeal> setmealLambdaQueryWrapper = new LambdaQueryWrapper<>();
        // 添加查询条件，根据分类id进行查询
        setmealLambdaQueryWrapper.eq(Setmeal::getCategoryId,id);
        int count2 = setmealService.count();
        if(count2 > 0){
            // 已经关联套餐，抛出一个业务异常
            throw new CustomException("当前分类下关联了套餐，不能删除");
        }

        // 正常删除分类
        super.removeById(id);
    }
}

```

> DishService

```java
/**
 * @ Name: DishService
 * @ Author: Cola
 * @ Time: 2022/12/27 19:41
 * @ Description: DishService
 */
public interface DishService extends IService<Dish> {
    //新增菜品，同时插入菜品对应的口味数据，需要操作两张表：dish、dish_flavor
    public void saveWithFlavor(DishDto dishDto);

    //根据id查询菜品信息和对应的口味信息
    public DishDto getByIdWithFlavor(Long id);

    //更新菜品信息，同时更新对应的口味信息
    public void updateWithFlavor(DishDto dishDto);
}

```

```java
/**
 * @ Name: DishServiceImpl
 * @ Author: Cola
 * @ Time: 2022/12/27 19:41
 * @ Description: DishServiceImpl
 */
@Service
@Slf4j
public class DishServiceImpl extends ServiceImpl<DishMapper, Dish> implements DishService {
    @Autowired
    private DishFlavorService dishFlavorService;

    /**
     * 新增菜品，同时保存对应的口味数据
     * @param dishDto
     */
    @Transactional
    public void saveWithFlavor(DishDto dishDto) {
        //保存菜品的基本信息到菜品表dish
        this.save(dishDto);

        Long dishId = dishDto.getId();//菜品id

        //菜品口味
        List<DishFlavor> flavors = dishDto.getFlavors();
        flavors = flavors.stream().map((item) -> {
            item.setDishId(dishId);
            return item;
        }).collect(Collectors.toList());

        //保存菜品口味数据到菜品口味表dish_flavor
        dishFlavorService.saveBatch(flavors);

    }

    /**
     * 根据id查询菜品信息和对应的口味信息
     * @param id
     * @return
     */
    public DishDto getByIdWithFlavor(Long id) {
        //查询菜品基本信息，从dish表查询
        Dish dish = this.getById(id);

        DishDto dishDto = new DishDto();
        BeanUtils.copyProperties(dish,dishDto);

        //查询当前菜品对应的口味信息，从dish_flavor表查询
        LambdaQueryWrapper<DishFlavor> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(DishFlavor::getDishId,dish.getId());
        List<DishFlavor> flavors = dishFlavorService.list(queryWrapper);
        dishDto.setFlavors(flavors);

        return dishDto;
    }

    @Override
    @Transactional
    public void updateWithFlavor(DishDto dishDto) {
        //更新dish表基本信息
        this.updateById(dishDto);

        //清理当前菜品对应口味数据---dish_flavor表的delete操作
        LambdaQueryWrapper<DishFlavor> queryWrapper = new LambdaQueryWrapper();
        queryWrapper.eq(DishFlavor::getDishId,dishDto.getId());

        dishFlavorService.remove(queryWrapper);

        //添加当前提交过来的口味数据---dish_flavor表的insert操作
        List<DishFlavor> flavors = dishDto.getFlavors();

        flavors = flavors.stream().map((item) -> {
            item.setDishId(dishDto.getId());
            return item;
        }).collect(Collectors.toList());

        dishFlavorService.saveBatch(flavors);
    }
}

```

> DishFlavorService

```java
/**
 * @ Name: DishFlavorService
 * @ Author: Cola
 * @ Time: 2022/12/27 19:42
 * @ Description: DishFlavorService
 */
public interface DishFlavorService extends IService<DishFlavor> {
}

```

```java
/**
 * @ Name: DishFlavorServiceImpl
 * @ Author: Cola
 * @ Time: 2022/12/27 19:43
 * @ Description: DishFlavorServiceImpl
 */
@Service
public class DishFlavorServiceImpl extends ServiceImpl<DishFlavorMapper, DishFlavor> implements DishFlavorService {
}

```

> EmployeeService

```java
/**
 * @ Name: EmployeeService
 * @ Author: Cola
 * @ Time: 2022/12/27 19:44
 * @ Description: EmployeeService
 */
public interface EmployeeService extends IService<Employee> {
}

```

```java
/**
 * @ Name: EmployeeServiceImpl
 * @ Author: Cola
 * @ Time: 2022/12/27 19:44
 * @ Description: EmployeeServiceImpl
 */
@Service
public class EmployeeServiceImpl extends ServiceImpl<EmployeeMapper, Employee> implements EmployeeService {
}

```

> OrderDetailService

```java
/**
 * @ Name: OrderDetailService
 * @ Author: Cola
 * @ Time: 2022/12/27 19:45
 * @ Description: OrderDetailService
 */
public interface OrderDetailService extends IService<OrderDetail> {
}

```

```java
/**
 * @ Name: OrderDetailServiceImpl
 * @ Author: Cola
 * @ Time: 2022/12/27 19:46
 * @ Description: OrderDetailServiceImpl
 */
@Service
public class OrderDetailServiceImpl extends ServiceImpl<OrderDetailMapper, OrderDetail> implements OrderDetailService {
}

```

> OdersService

```java
/**
 * @ Name: OrdersService
 * @ Author: Cola
 * @ Time: 2022/12/27 19:47
 * @ Description: OrdersService
 */
public interface OrdersService extends IService<Orders> {

    /**
     * 用户下单
     * @param orders orders
     */
    void submit(Orders orders);
}

```

```java
/**
 * @ Name: OrdersServiceImpl
 * @ Author: Cola
 * @ Time: 2022/12/27 19:47
 * @ Description: OrdersServiceImpl
 */
@Service
@Slf4j
public class OrdersServiceImpl extends ServiceImpl<OrdersMapper, Orders> implements OrdersService {
    @Resource
    private ShoppingCartService shoppingCartService;

    @Resource
    private UserService userService;

    @Resource
    private AddressBookService addressBookService;

    @Resource
    private OrderDetailService orderDetailService;

    /**
     * 用户下单
     * @param orders
     */
    @Transactional
    @Override
    public void submit(Orders orders) {
        //获得当前用户id
        Long userId = BaseContext.getCurrentId();

        //查询当前用户的购物车数据
        LambdaQueryWrapper<ShoppingCart> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(ShoppingCart::getUserId,userId);
        List<ShoppingCart> shoppingCarts = shoppingCartService.list(wrapper);

        if(shoppingCarts == null || shoppingCarts.size() == 0){
            throw new CustomException("购物车为空，不能下单");
        }

        //查询用户数据
        User user = userService.getById(userId);

        //查询地址数据
        Long addressBookId = orders.getAddressBookId();
        AddressBook addressBook = addressBookService.getById(addressBookId);
        if(addressBook == null){
            throw new CustomException("用户地址信息有误，不能下单");
        }

        long orderId = IdWorker.getId();//订单号

        AtomicInteger amount = new AtomicInteger(0);

        List<OrderDetail> orderDetails = shoppingCarts.stream().map((item) -> {
            OrderDetail orderDetail = new OrderDetail();
            orderDetail.setOrderId(orderId);
            orderDetail.setNumber(item.getNumber());
            orderDetail.setDishFlavor(item.getDishFlavor());
            orderDetail.setDishId(item.getDishId());
            orderDetail.setSetmealId(item.getSetmealId());
            orderDetail.setName(item.getName());
            orderDetail.setImage(item.getImage());
            orderDetail.setAmount(item.getAmount());
            amount.addAndGet(item.getAmount().multiply(new BigDecimal(item.getNumber())).intValue());
            return orderDetail;
        }).collect(Collectors.toList());


        orders.setId(orderId);
        orders.setOrderTime(LocalDateTime.now());
        orders.setCheckoutTime(LocalDateTime.now());
        orders.setStatus(2);
        orders.setAmount(new BigDecimal(amount.get()));//总金额
        orders.setUserId(userId);
        orders.setNumber(String.valueOf(orderId));
        orders.setUserName(user.getName());
        orders.setConsignee(addressBook.getConsignee());
        orders.setPhone(addressBook.getPhone());
        orders.setAddress((addressBook.getProvinceName() == null ? "" : addressBook.getProvinceName())
                + (addressBook.getCityName() == null ? "" : addressBook.getCityName())
                + (addressBook.getDistrictName() == null ? "" : addressBook.getDistrictName())
                + (addressBook.getDetail() == null ? "" : addressBook.getDetail()));
        //向订单表插入数据，一条数据
        this.save(orders);

        //向订单明细表插入数据，多条数据
        orderDetailService.saveBatch(orderDetails);

        //清空购物车数据
        shoppingCartService.remove(wrapper);
    }
}

```

> SetmealService

```java
/**
 * @ Name: SetmealService
 * @ Author: Cola
 * @ Time: 2022/12/27 19:49
 * @ Description: SetmealService
 */
public interface SetmealService extends IService<Setmeal> {
    /**
     * 新增套餐，同时需要保存套餐和菜品的关联关系
     * @param setmealDto
     */
    public void saveWithDish(SetmealDto setmealDto);

    /**
     * 删除套餐，同时需要删除套餐和菜品的关联数据
     * @param ids
     */
    public void removeWithDish(List<Long> ids);
}

```

```java
/**
 * @ Name: SetmealServiceImpl
 * @ Author: Cola
 * @ Time: 2022/12/27 19:49
 * @ Description: SetmealServiceImpl
 */
@Service
@Slf4j
public class SetmealServiceImpl extends ServiceImpl<SetmealMapper, Setmeal> implements SetmealService {
    @Autowired
    private SetmealDishService setmealDishService;

    /**
     * 新增套餐，同时需要保存套餐和菜品的关联关系
     * @param setmealDto
     */
    @Transactional
    public void saveWithDish(SetmealDto setmealDto) {
        //保存套餐的基本信息，操作setmeal，执行insert操作
        this.save(setmealDto);

        List<SetmealDish> setmealDishes = setmealDto.getSetmealDishes();
        setmealDishes.stream().map((item) -> {
            item.setSetmealId(setmealDto.getId());
            return item;
        }).collect(Collectors.toList());

        //保存套餐和菜品的关联信息，操作setmeal_dish,执行insert操作
        setmealDishService.saveBatch(setmealDishes);
    }

    /**
     * 删除套餐，同时需要删除套餐和菜品的关联数据
     * @param ids
     */
    @Transactional
    public void removeWithDish(List<Long> ids) {
        //select count(*) from setmeal where id in (1,2,3) and status = 1
        //查询套餐状态，确定是否可用删除
        LambdaQueryWrapper<Setmeal> queryWrapper = new LambdaQueryWrapper();
        queryWrapper.in(Setmeal::getId,ids);
        queryWrapper.eq(Setmeal::getStatus,1);

        int count = this.count(queryWrapper);
        if(count > 0){
            //如果不能删除，抛出一个业务异常
            throw new CustomException("套餐正在售卖中，不能删除");
        }

        //如果可以删除，先删除套餐表中的数据---setmeal
        this.removeByIds(ids);

        //delete from setmeal_dish where setmeal_id in (1,2,3)
        LambdaQueryWrapper<SetmealDish> lambdaQueryWrapper = new LambdaQueryWrapper<>();
        lambdaQueryWrapper.in(SetmealDish::getSetmealId,ids);
        //删除关系表中的数据----setmeal_dish
        setmealDishService.remove(lambdaQueryWrapper);
    }
}

```

> SetmealDishService

```java
/**
 * @ Name: SetmealDishService
 * @ Author: Cola
 * @ Time: 2022/12/27 19:50
 * @ Description: SetmealDishService
 */
public interface SetmealDishService extends IService<SetmealDish> {
}

```

```java
/**
 * @ Name: SetmealDishServiceImpl
 * @ Author: Cola
 * @ Time: 2022/12/27 19:50
 * @ Description: SetmealDishServiceImpl
 */
@Service
public class SetmealDishServiceImpl extends ServiceImpl<SetmealDishMapper, SetmealDish> implements SetmealDishService {
}

```

> ShoppingCartService

```java
/**
 * @ Name: ShoppingCartService
 * @ Author: Cola
 * @ Time: 2022/12/27 19:52
 * @ Description: ShoppingCartService
 */
public interface ShoppingCartService extends IService<ShoppingCart> {
}

```

```java
/**
 * @ Name: ShoppingCartServiceImpl
 * @ Author: Cola
 * @ Time: 2022/12/27 19:52
 * @ Description: ShoppingCartServiceImpl
 */
@Service
public class ShoppingCartServiceImpl extends ServiceImpl<ShoppingCartMapper, ShoppingCart> implements ShoppingCartService {
}

```

> UserService

```java
/**
 * @ Name: UserService
 * @ Author: Cola
 * @ Time: 2022/12/27 19:53
 * @ Description: UserService
 */
public interface UserService extends IService<User> {
}

```

```java
/**
 * @ Name: UserServiceImpl
 * @ Author: Cola
 * @ Time: 2022/12/27 19:53
 * @ Description: UserServiceImpl
 */
@Service
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements UserService {
}
```


### 二、Reggie Pro

> - [ ] Docker 的基本使用
> - [ ] Redis
> - [ ] Nginx
> - [ ] 主从数据库

#### 2.1 Docker 的基本使用

> 本处采用腾讯云服务器进行记录，虚拟机下的使用：（EX：参见 [使用 VM 在 CentOS7 下安装 Docker](TODO)）,注：本处仅介绍 Docker 的使用具体的安装同上（虚拟机）。
>
> - [ ] 使用 Docker 安装 MySQL
> - [ ] 使用 Docker 安装 Redis
> - [ ] 使用 Docker 安装 Nginx
> - [ ] 使用 Docker 安装 JDK 并通过 Shell 脚本热部署 Maven 项目

##### 2.1.1 使用 Docker 安装 MySQL

> 使用 Docker 安装 MySQL

##### 2.1.2 使用 Docker 安装 Redis

> 使用 Docker 安装 Redis

##### 2.1.3 使用 Docker 安装 Nginx

> 使用 Docker 安装 Nginx

##### 2.1.4 使用 Docker 安装 JDK 并通过 Shell 脚本热部署 Maven 项目

> 使用 Docker 安装 JDK 并通过 Shell 脚本热部署 Maven 项目

#### 2.2 Redis

> Redis

#### 2.3 Nginx

> Nginx

#### 2.4 主从数据库

> 主从数据库

### 三、收获

> - [x] 静态资源映射
> - [x] 实体集 R
> - [x] 设置全局过滤器，对特定的 URi 进行登录检查
> - [x] 借助 MyBatisPlus 的 `@TableField` 注解实现对公共字段的填充
> - [x] 全局异常处理器
> - [x] SpringBoot 实现文件的上传下载

#### 3.1 静态资源映射

> 默认情况下 `SpringBoot` 推荐我们将前端等静态资源存放于 `classpath` 下的 `static` 和 `template` 目录下（此时我们可以对相应的资源直接访问），但有时候我们需要自定义资源的存放路径，这个时候就需要对其进行额外配置：
>
> - 添加 `WebMvcConfig` 配置类

```java
/**
 * @ Name: WebMvcConfig
 * @ Author: Cola
 * @ Time: 2022/12/27 18:26
 * @ Description: WebMvcConfig
 */
@Configuration
@Slf4j
public class WebMvcConfig extends WebMvcConfigurationSupport {

    /**
     * 设置静态资源映射
     * @param registry
     */
    @Override
    protected void addResourceHandlers(ResourceHandlerRegistry registry) {
        log.info("开始进行静态资源映射...");
        registry.addResourceHandler("/backend/**").
                addResourceLocations("classpath:/backend/");
        registry.addResourceHandler("/front/**").
                addResourceLocations("classpath:/front/");
    }
}
```

#### 3.2 实体集 R

> 在于前端交互的过程中我们经常需要返回各类的数据如果不对其进行规范极大的影响开发体验，因此我们可以将需要返回的数据封装为实体集，我们只需要在返回的时候使用泛型对其进行约束即可、

```java
/**
 * @ Name: R
 * @ Author: Cola
 * @ Time: 2022/12/27 17:47
 * @ Description: R 结果集
 */
@Data
public class R<T> {

    private Integer code; //编码：1成功，0和其它数字为失败

    private String msg; //错误信息

    private T data; //数据

    private Map map = new HashMap(); //动态数据

    public static <T> R<T> success(T object) {
        R<T> r = new R<T>();
        r.data = object;
        r.code = 1;
        return r;
    }

    public static <T> R<T> error(String msg) {
        R r = new R();
        r.msg = msg;
        r.code = 0;
        return r;
    }

    public R<T> add(String key, Object value) {
        this.map.put(key, value);
        return this;
    }

}
```

#### 3.3 设置全局过滤器，对特定的 URI 进行登录检查

> 在开发登录功能的过程中，为了防止用户通过直接访问目标 URI 的方式跳过登录，我们需要对特定的 URI 进行拦截检查：
>
> - 配置 `LoginCheckFitter` 类
> - 在启动类 `ManagerApplication` 中加入 `@ServletComponentScan`注解开启组件扫描

```java
/**
 * @ Name: LoginCheckFilter
 * @ Author: Cola
 * @ Time: 2022/12/27 20:16
 * @ Description: 检查用户是否已经完成登录
 */
@WebFilter(filterName = "loginCheckFilter",urlPatterns = "/*")
@Slf4j
public class LoginCheckFilter implements Filter {
    /*
    路径匹配器，支持通配符
     */
    public static final AntPathMatcher PATH_MATCHER = new AntPathMatcher();

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {

        HttpServletRequest request = (HttpServletRequest) servletRequest;
        HttpServletResponse response = (HttpServletResponse) servletResponse;

        /*
        获取本次请求的URI
         */
        String requestURI = request.getRequestURI();

        log.info("拦截到请求：{}",requestURI);

        /*
        定义不需要处理的请求路径
         */
        String[] urls = new String[]{
                "/employee/login",
                "/employee/logout",
                "/backend/**",
                "/front/**",
                "/common/**",
                "/user/sendMsg",
                "/user/login"
        };

        /*
        判断本次请求是否需要处理
         */
        boolean check = check(urls, requestURI);

        /*
        如果不需要处理，则直接放行
         */
        if(check){
            log.info("本次请求{}不需要处理",requestURI);
            filterChain.doFilter(request,response);
            return;
        }

        /*
        判断 employee 登录状态，如果已登录，则直接放行
         */
        if(request.getSession().getAttribute("employee") != null){
            log.info("用户已登录，用户id为：{}",request.getSession().getAttribute("employee"));

            Long empId = (Long) request.getSession().getAttribute("employee");
            /*
            设置 CurrentId
             */
            BaseContext.setCurrentId(empId);

            filterChain.doFilter(request,response);
            return;
        }

        /*

        判断 user 登录状态，如果已登录，则直接放行
         */
        if(request.getSession().getAttribute("user") != null){
            log.info("用户已登录，用户id为：{}",request.getSession().getAttribute("user"));

            Long userId = (Long) request.getSession().getAttribute("user");
            /*
            设置 CurrentId
             */
            BaseContext.setCurrentId(userId);

            filterChain.doFilter(request,response);
            return;
        }

        log.info("用户未登录");
        /*
        如果未登录则返回未登录结果，通过输出流方式向客户端页面响应数据
         */
        response.getWriter().write(JSON.toJSONString(R.error("NOTLOGIN")));

    }

    /**
     * 路径匹配，检查本次请求是否需要放行
     * @param urls url 白名单
     * @param requestURI 当前 URL
     * @return 是否有权限
     */
    public boolean check(String @NotNull [] urls, String requestURI){
        for (String url : urls) {
            boolean match = PATH_MATCHER.match(url, requestURI);
            if(match){
                return true;
            }
        }
        return false;
    }

}

```

```java
/**
 * @ Name: ManagerApplication
 * @ Author: Cola
 * @ Time: 2022/12/27 18:03
 * @ Description: ManagerApplication
 */
@SpringBootApplication
@ServletComponentScan
@Slf4j
public class ManagerApplication {
    public static void main(String[] args) {
        SpringApplication.run(ManagerApplication.class);
        log.info("项目启动成功");
    }
}

```

#### 3.4 借助 MyBatisPlus 的 `@TableField` 注解实现对公共字段的填充

> 对一些公共字段，我们可以使用 MyBatisPlus 的 `@TableField` 注解实现填充。
>
> - 配置 `MyMetaObjecthandler` 并实现 `MetaObjectHandler` 接口
> - 因为 `MyMetaObjecthandler` 无法获取存储在 session 中的 id 因此我们需要使用 `ThreadLocal` 对其进行设置和获取（同一请求下 controller 、共用同一个线程）
> - 配置 `BaseContext` 工具类
> - 在需要填充的字段上标注 `TableField` 注解

```java
/**
 * @ Name: MyMetaObjecthandler
 * @ Author: Cola
 * @ Time: 2022/12/27 20:12
 * @ Description: 自定义元数据对象处理器
 */
@Component
@Slf4j
public class MyMetaObjecthandler implements MetaObjectHandler {
    /**
     * 插入操作，自动填充
     * @param metaObject
     */
    @Override
    public void insertFill(@NotNull MetaObject metaObject) {
        log.info("公共字段自动填充[insert]...");
        log.info(metaObject.toString());

        metaObject.setValue("createTime", LocalDateTime.now());
        metaObject.setValue("updateTime",LocalDateTime.now());
        metaObject.setValue("createUser",BaseContext.getCurrentId());
        metaObject.setValue("updateUser",BaseContext.getCurrentId());
    }

    /**
     * 更新操作，自动填充
     * @param metaObject
     */
    @Override
    public void updateFill(@NotNull MetaObject metaObject) {
        log.info("公共字段自动填充[update]...");
        log.info(metaObject.toString());

        long id = Thread.currentThread().getId();
        log.info("线程id为：{}",id);

        metaObject.setValue("updateTime", LocalDateTime.now());
        metaObject.setValue("updateUser",BaseContext.getCurrentId());
    }
}

```

```java
package xyz.ccola.common;

/**
 * @ Name: BaseContext
 * @ Author: Cola
 * @ Time: 2022/12/27 20:11
 * @ Description: 基于 ThreadLocal 封装工具类，用户保存和获取当前登录用户 id
 */
public class BaseContext {
    private static ThreadLocal<Long> threadLocal = new ThreadLocal<>();

    /**
     * 设置值
     * @param id 当前登录用户的 id
     */
    public static void setCurrentId(Long id){
        threadLocal.set(id);
    }

    /**
     * 获取值
     * @return ThreadLocal 中的值
     */
    public static Long getCurrentId(){
        return threadLocal.get();
    }
}

```

```java
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;

    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;

    @TableField(fill = FieldFill.INSERT)
    private Long createUser;

    @TableField(fill = FieldFill.INSERT_UPDATE)
    private Long updateUser;
```

#### 3.5 全局异常处理器

> 为了避免因异常而导致的项目崩溃，我们需要为程序设定全局异常处理器，将异常进行处理，而非让其阻塞程序的执行。

```java
/**
 * @ Name: GlobalExceptionHandler
 * @ Author: Cola
 * @ Time: 2022/12/27 20:13
 * @ Description: 全局异常处理
 */

@ControllerAdvice(annotations = {RestController.class, Controller.class})
@ResponseBody
@Slf4j
public class GlobalExceptionHandler {

    /**
     * 异常处理方法
     * @return R
     */
    @ExceptionHandler(SQLIntegrityConstraintViolationException.class)
    public R<String> exceptionHandler(@NotNull SQLIntegrityConstraintViolationException ex){
        log.error(ex.getMessage());

        if(ex.getMessage().contains("Duplicate entry")){
            String[] split = ex.getMessage().split(" ");
            String msg = split[2] + "已存在";
            return R.error(msg);
        }

        return R.error("未知错误");
    }

    /**
     * 异常处理方法
     * @return R
     */
    @ExceptionHandler(CustomException.class)
    public R<String> exceptionHandler(@NotNull CustomException ex){
        log.error(ex.getMessage());

        return R.error(ex.getMessage());
    }

}
```

#### 3.6 SpringBoot 实现文件的上传下载

> 大部分情况下，我们需要对文件实现上传和下载，在 SpringBoot 中我们可以采用文件输出输入流的方式实现：

```java
package xyz.ccola.controller.controller;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;
import xyz.ccola.domain.R;

import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServletResponse;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.util.UUID;

/**
 * @ Name: CommonController
 * @ Author: Cola
 * @ Time: 2022/12/27 23:53
 * @ Description: CommonController 文件上传和下载
 */
@RestController
@RequestMapping("/common")
@Slf4j
public class CommonController {

    @Value("${reggie.path}")
    private String basePath;

    /**
     * 文件上传
     * @param file
     * @return
     */
    @PostMapping("/upload")
    public R<String> upload(MultipartFile file){
        //file是一个临时文件，需要转存到指定位置，否则本次请求完成后临时文件会删除
        log.info(file.toString());

        //原始文件名
        String originalFilename = file.getOriginalFilename();//abc.jpg
        String suffix = originalFilename.substring(originalFilename.lastIndexOf("."));

        //使用UUID重新生成文件名，防止文件名称重复造成文件覆盖
        String fileName = UUID.randomUUID().toString() + suffix;//dfsdfdfd.jpg

        //创建一个目录对象
        File dir = new File(basePath);
        //判断当前目录是否存在
        if(!dir.exists()){
            //目录不存在，需要创建
            dir.mkdirs();
        }

        try {
            //将临时文件转存到指定位置
            file.transferTo(new File(basePath + fileName));
        } catch (IOException e) {
            e.printStackTrace();
        }
        return R.success(fileName);
    }

    /**
     * 文件下载
     * @param name
     * @param response
     */
    @GetMapping("/download")
    public void download(String name, HttpServletResponse response){

        try {
            //输入流，通过输入流读取文件内容
            FileInputStream fileInputStream = new FileInputStream(new File(basePath + name));

            //输出流，通过输出流将文件写回浏览器
            ServletOutputStream outputStream = response.getOutputStream();

            response.setContentType("image/jpeg");

            int len = 0;
            byte[] bytes = new byte[1024];
            while ((len = fileInputStream.read(bytes)) != -1){
                outputStream.write(bytes,0,len);
                outputStream.flush();
            }

            //关闭资源
            outputStream.close();
            fileInputStream.close();
        } catch (Exception e) {
            e.printStackTrace();
        }

    }
}


```

